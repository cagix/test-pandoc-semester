name: Update Generated GitHub Preview

on:
  # scheduled
  schedule:
    # every day at 5:30 and 17:30 UTC
    - cron:  "30 5,17 * * *"
  # triggered manually
  workflow_dispatch:

jobs:
  sync_lecture:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout our semester-repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Checkout external lecture-repo (_gfm branch)
        uses: actions/checkout@v5
        with:
          repository: cagix/test-pandoc-lecture  ##
          fetch-depth: 0
          ref: _gfm
          path: _gfm
      - name: Retrieve last commit message from lecture-repo
        id: message
        run: |
          cd _gfm/
          msg="$(git log -n 1 --pretty=reference | sed -e 's/["\\$$`]//g' -e "s/'//g")"
          echo "COMMIT_MESSAGE=$msg" >> "$GITHUB_OUTPUT"
          cd ..
      - name: Copy files over
        run: |
          rm -rf admin/ lecture/ homework/
          cp -r _gfm/* .
          rm -rf _gfm/
      - name: Commit and push
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "cagix"
            git config user.email "cagix@users.noreply.github.com"
            git add -f .
            git commit -m '${{ steps.message.outputs.COMMIT_MESSAGE }}'
            git push
          else
            echo "no changes to push"
          fi
